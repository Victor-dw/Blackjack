version: "3.9"

services:
  # --- Data services ---
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: blackjack
      POSTGRES_PASSWORD: blackjack
      POSTGRES_DB: blackjack
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - compute-network

  redis-compute:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    networks:
      - compute-network

  # Trade-plane Redis is physically isolated (only started in live profile).
  redis-trade:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    profiles: ["live"]
    volumes:
      - redistrade:/data
    networks:
      - trade-network

  clickhouse:
    image: clickhouse/clickhouse-server:24
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - chdata:/var/lib/clickhouse
    networks:
      - compute-network

  # --- Core pipeline services (skeleton placeholders) ---
  data-collector:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.perception.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - data-network
      - compute-network

  variable-engine:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.variables.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  signal-engine:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.signals.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  strategy-engine:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.strategies.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  risk-engine:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.risk.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  # Execution is never started by default.
  # Use `--profile dry` for sandbox execution, or `--profile live` for real execution.
  executor-dry:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.execution.service"]
    profiles: ["dry"]
    depends_on: [redis-compute]
    environment:
      BLACKJACK_REDIS_URL: "redis://redis-compute:6379/0"
    networks:
      - compute-network

  # Trade bridge is the *only* network connector from compute-plane â†’ trade-plane.
  trade-bridge:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.trade_bridge.service"]
    profiles: ["live"]
    depends_on: [redis-compute, redis-trade]
    environment:
      BLACKJACK_REDIS_URL: "redis://redis-compute:6379/0"
      BLACKJACK_REDIS_TRADE_URL: "redis://redis-trade:6379/0"
    networks:
      - compute-network
      - trade-network

  executor-live:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.execution.service"]
    profiles: ["live"]
    depends_on: [redis-trade]
    environment:
      BLACKJACK_REDIS_URL: "redis://redis-trade:6379/0"
    networks:
      - trade-network

  postmortem:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.postmortem.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  # Evolution/backtest must be isolated from live execution.
  backtest:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.evolution.service"]
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "src.api.main"]
    ports:
      - "8000:8000"
    depends_on: [redis-compute, postgres]
    networks:
      - compute-network

networks:
  data-network:
    name: blackjack-data-network
  compute-network:
    name: blackjack-compute-network
  trade-network:
    name: blackjack-trade-network
  monitor-network:
    name: blackjack-monitor-network

volumes:
  pgdata:
  redisdata:
  redistrade:
  chdata:
